<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ìœ  ì„­ì·¨ ì²´í¬</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Top Half: App Usage Instructions -->
        <div class="instructions-section">
            <h1>ğŸ¥› ìš°ìœ  ì„­ì·¨ ì²´í¬</h1>
            <div class="instructions-content">
                <p>ë‹´ì„ êµì‚¬ê°€ í•™ìƒë“¤ì˜ ìš°ìœ  ì„­ì·¨ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <p>í•™ìƒë“¤ì€ í‚¤ê°€ ì‘ì•„ ì§ì ‘ ì†ì„ ë»—ê¸° ì–´ë ¤ìš°ë¯€ë¡œ, êµì‚¬ê°€ ëŒ€ì‹  ì²´í¬í•´ ì£¼ì„¸ìš”.</p>
                <p class="muted">â€» ì €ì¥ ë°©ì‹: ì´ ê¸°ê¸°ì˜ ë¸Œë¼ìš°ì € <b>localStorage</b>ì— ì €ì¥ë©ë‹ˆë‹¤. ê¸°ê¸°/ë¸Œë¼ìš°ì €ë¥¼ ë°”ê¾¸ë©´ ë°ì´í„°ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆì–´ìš”.</p>
            </div>
        </div>
        
        <!-- Bottom Half: Student Cards and Controls -->
        <div class="app-section">
            <header class="header">
                <div class="controls">
                    <div class="control-group">
                        <label for="date-input">ë‚ ì§œ:</label>
                        <input type="date" id="date-input" value="{{ today }}">
                    </div>
                    
                    <div class="control-group">
                        <label for="gender-filter">í•„í„°:</label>
                        <select id="gender-filter">
                            <option value="all">ì „ì²´</option>
                            <option value="M">ë‚¨í•™ìƒ</option>
                            <option value="F">ì—¬í•™ìƒ</option>
                        </select>
                    </div>
                    
                    <div class="control-group">
                        <button id="toggle-all" class="btn btn-secondary">ëª¨ë‘ ì²´í¬</button>
                    </div>
                    
                    <div class="control-group">
                        <!-- ê¸°ì¡´: CSV ì €ì¥ / CSV ë‹¤ìš´ë¡œë“œ  â†’  ë³€ê²½: CSV ë‚´ë³´ë‚´ê¸° / CSV ë¶ˆëŸ¬ì˜¤ê¸° -->
                        <button id="export-csv" class="btn btn-primary">CSV ë‚´ë³´ë‚´ê¸°</button>
                        <button id="import-csv-btn" class="btn btn-success">CSV ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <input type="file" id="import-csv-input" accept=".csv" style="display:none;">
                    </div>
                </div>
                
                <div id="status-message" class="status-message"></div>
            </header>
            
            <main>
                <div id="students-grid" class="students-grid">
                    <!-- Student cards will be populated here -->
                </div>
                
                <div id="loading" class="loading" style="display: none;">
                    ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </main>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='app.js') }}"></script>

    <!-- localStorage ê¸°ë°˜ ë‚´ë³´ë‚´ê¸°/ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§ -->
    <script>
    // ====== ì €ì¥ì†Œ í‚¤ ê·œì¹™: ë‚ ì§œë³„ ë¶„ë¦¬ ======
    function storageKeyFor(dateStr) {
      return `milkData:${dateStr}`; // ì˜ˆ: milkData:2025-08-21
    }

    function loadFromLocalStorage(dateStr) {
      try {
        const raw = localStorage.getItem(storageKeyFor(dateStr));
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        console.error("loadFromLocalStorage error:", e);
        return {};
      }
    }

    function saveToLocalStorage(dateStr, dataObj) {
      try {
        localStorage.setItem(storageKeyFor(dateStr), JSON.stringify(dataObj));
        // ì•± ìª½ ë¦¬ë Œë”ë¥¼ ì›í•˜ë©´ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œìƒ
        document.dispatchEvent(new CustomEvent('milkDataUpdated', { detail: { date: dateStr } }));
      } catch (e) {
        console.error("saveToLocalStorage error:", e);
      }
    }

    // ====== CSV ë‚´ë³´ë‚´ê¸° ======
    document.getElementById('export-csv').addEventListener('click', () => {
      const dateInput = document.getElementById('date-input');
      const dateStr = dateInput?.value || '';
      if (!dateStr) {
        alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      const data = loadFromLocalStorage(dateStr); // { student_id: {name, gender, status}, ... } ê¶Œì¥
      const ids = Object.keys(data);
      if (ids.length === 0) {
        alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // CSV í—¤ë” êµ¬ì„±(í•„ìš”ì— ë§ê²Œ ì»¬ëŸ¼ ì¶”ê°€/ì‚­ì œ ê°€ëŠ¥)
      let csv = 'date,student_id,name,gender,status\n';
      ids.forEach(id => {
        const { name = '', gender = '', status = '' } = data[id] || {};
        csv += `${dateStr},${id},${escapeCSV(name)},${escapeCSV(gender)},${escapeCSV(status)}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `milk_${dateStr}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    function escapeCSV(val) {
      const s = String(val ?? '');
      if (s.includes(',') || s.includes('"') || s.includes('\n')) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }

    // ====== CSV ë¶ˆëŸ¬ì˜¤ê¸° ======
    const importBtn = document.getElementById('import-csv-btn');
    const importInput = document.getElementById('import-csv-input');

    importBtn.addEventListener('click', () => importInput.click());

    importInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      const dateStr = document.getElementById('date-input')?.value || '';
      if (!dateStr) {
        alert('CSVë¥¼ ì ìš©í•  ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
        importInput.value = '';
        return;
      }

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const text = evt.target.result;
          // ì²« ì¤„ì´ í—¤ë”ë¼ê³  ê°€ì •: date,student_id,name,gender,status
          const lines = text.split(/\r?\n/).filter(Boolean);
          if (lines.length <= 1) {
            alert('CSV ë‚´ìš©ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
            importInput.value = '';
            return;
          }
          const header = lines[0].split(',').map(h => h.trim().toLowerCase());
          const di = {
            date: header.indexOf('date'),
            id: header.indexOf('student_id'),
            name: header.indexOf('name'),
            gender: header.indexOf('gender'),
            status: header.indexOf('status')
          };

          const nextData = {};
          for (let i = 1; i < lines.length; i++) {
            const row = parseCSVLine(lines[i]);
            if (!row || row.length === 0) continue;

            const rowDate = di.date >= 0 ? row[di.date] : dateStr;
            if (rowDate && rowDate !== dateStr) {
              // ë‹¤ë¥¸ ë‚ ì§œì˜ í–‰ì€ ê±´ë„ˆë›°ê±°ë‚˜, í•„ìš”í•˜ë©´ ë³‘í•© ë¡œì§ì„ ë„£ìœ¼ì„¸ìš”.
              continue;
            }
            const sid = di.id >= 0 ? row[di.id] : '';
            if (!sid) continue;

            const name = di.name >= 0 ? row[di.name] : '';
            const gender = di.gender >= 0 ? row[di.gender] : '';
            const status = di.status >= 0 ? row[di.status] : '';
            nextData[sid] = { name, gender, status };
          }

          saveToLocalStorage(dateStr, nextData);
          alert('CSV ë¶ˆëŸ¬ì˜¤ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          // í™”ë©´ ë¦¬í”„ë ˆì‹œê°€ í•„ìš”í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
          // location.reload();
        } catch (err) {
          console.error(err);
          alert('CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        } finally {
          importInput.value = '';
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    // ê°„ë‹¨í•œ CSV íŒŒì„œ(ë”°ì˜´í‘œ í¬í•¨ ê°’ ì§€ì›)
    function parseCSVLine(line) {
      const result = [];
      let cur = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"') {
            if (line[i + 1] === '"') {
              cur += '"'; i++; // ì´ìŠ¤ì¼€ì´í”„ëœ ë”°ì˜´í‘œ
            } else {
              inQuotes = false;
            }
          } else {
            cur += ch;
          }
        } else {
          if (ch === '"') {
            inQuotes = true;
          } else if (ch === ',') {
            result.push(cur);
            cur = '';
          } else {
            cur += ch;
          }
        }
      }
      result.push(cur);
      return result.map(s => s.trim());
    }

    // ====== (ì„ íƒ) ì•±ê³¼ ë°ì´í„° ì—°ë™ ê°€ì´ë“œ ======
    // 1) app.jsì—ì„œ í•™ìƒ ìƒíƒœê°€ ë°”ë€” ë•Œë§ˆë‹¤ ì•„ë˜ í˜•íƒœë¡œ ì €ì¥í•˜ì„¸ìš”:
    //    const dateStr = document.getElementById('date-input').value; // "YYYY-MM-DD"
    //    const dataObj = { "1": {name:"1ë²ˆ", gender:"M", status:"Y"}, "2": {...} };
    //    saveToLocalStorage(dateStr, dataObj);
    //
    // 2) ì´ˆê¸° ë Œë” ì‹œì—ë„:
    //    const dataObj = loadFromLocalStorage(dateStr);
    //    -> ì´ ê°’ì„ ì‚¬ìš©í•´ ì¹´ë“œ ìƒíƒœë¥¼ ë³µì›í•˜ì„¸ìš”.
    //
    // 3) ë³¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°(ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸°)ë§Œ ë‹´ë‹¹í•©ë‹ˆë‹¤.
    </script>
</body>
</html>
